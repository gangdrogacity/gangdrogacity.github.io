<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>GDC Modpack Download</title>
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root {
      --bg-light: #f8f9fa;
      --bg-dark: #181818;
      --card-light: #ffffff;
      --card-dark: #242424;
      --text-light: #212529;
      --text-dark: #f1f1f1;
      --muted-light: #6c757d;
      --muted-dark: #bbb;
      --accent: #0d6efd;
    }
    body {
      background: var(--bg-light);
      color: var(--text-light);
      transition: background 0.3s, color 0.3s;
      overflow-x: hidden;
    }
    .card {
      background: var(--card-light);
      color: var(--text-light);
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      border-radius: .75rem;
      transition: transform 0.3s, box-shadow 0.3s;
      opacity: 0;
      transform: translateY(20px);
      animation: fadeUp 0.6s forwards;
    }
    .card:hover {
      transform: scale(1.03);
      box-shadow: 0 8px 16px rgba(0,0,0,0.2);
    }
    .btn {
      transition: transform 0.1s ease;
    }
    .btn:active {
      transform: scale(0.97);
    }
    h1 { font-weight: 300; }
    #latest-status { font-size: 0.9rem; }
    @keyframes fadeUp { to { opacity: 1; transform: translateY(0); } }
    .btn-accent {
      background: var(--accent);
      color: #fff;
      font-weight: bold;
      padding: 0.75rem 1.5rem;
      border-radius: 2rem;
      box-shadow: 0 4px 10px rgba(13,110,253,0.4);
      transition: background 0.3s, transform 0.3s;
      animation: pulse 2s infinite;
    }
    .btn-accent:hover {
      background: #0b5ed7;
      transform: scale(1.05);
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(13,110,253,0.7); }
      70% { box-shadow: 0 0 0 10px rgba(13,110,253,0); }
      100% { box-shadow: 0 0 0 0 rgba(13,110,253,0); }
    }
    .btn-purple { background-color: #6f42c1; color: #fff; transition: transform 0.1s ease; }
    .btn-purple:hover { background-color: #5936a1; transform: scale(1.02); }
    .dark-mode body { background: var(--bg-dark); color: var(--text-dark); }
    .dark-mode .card { background: var(--card-dark); color: var(--text-dark); box-shadow: 0 4px 6px rgba(255,255,255,0.1); }
    .dark-mode .text-muted { color: var(--muted-dark) !important; }
    .dark-mode .modal-content,
    .dark-mode .modal-header,
    .dark-mode .modal-body,
    .dark-mode .modal-footer {
      background: var(--card-dark);
      color: var(--text-dark);
    }
    .dark-mode .btn-close { filter: invert(1); }
    #theme-toggle { transition: background 0.3s, color 0.3s; }
    /* Floating alert */
    #dark-alert {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      z-index: 1050;
      display: flex;
      align-items: center;
      background: rgba(255,255,255,0.9);
      color: var(--text-light);
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      opacity: 0;
      transition: opacity 0.5s;
    }
    .dark-mode #dark-alert {
      background: rgba(32,32,32,0.9);
      color: var(--text-dark);
    }
    #dark-alert.show {
      opacity: 1;
    }
    #dark-alert button.close-alert {
      background: transparent;
      border: none;
      font-size: 1.2rem;
      margin-left: 0.5rem;
      cursor: pointer;
      color: inherit;
    }
  </style>
</head>
<body>
  <div id="dark-alert">
    Ti fanno male gli occhi? Perché non attivi la dark mode! 
    <button class="close-alert" aria-label="Chiudi">×</button>
  </div>

  <div class="container py-5">
    <div class="d-flex justify-content-end mb-3">
      <button id="theme-toggle" class="btn btn-sm btn-outline-secondary">Dark Mode</button>
    </div>
    <h1 class="text-center mb-5">GDC Modpack Download Center</h1>

    <!-- Hero card for latest release -->
    <div id="hero-card" class="card mb-5 text-center p-4" style="animation-delay:0ms;">
      <h2 class="mb-3">Scarica subito l'ultima release</h2>
      <p class="mb-4 text-muted">Versione <span id="hero-version">...</span> pubblicata il <span id="hero-date">...</span></p>
      <button id="hero-download-btn" class="btn btn-lg btn-accent">Scarica Ora</button>
    </div>

    <!-- Sezione Release -->
    <div class="card mb-5" style="animation-delay:100ms;">
      <div class="card-body">
        <h5 class="card-title mb-4">Releases</h5>
        <div id="releases-row" class="row g-4"></div>
      </div>
    </div>

    <!-- Sezione Installazione manuale GDC RP -->
    <div id="latest-card" class="card" style="animation-delay:200ms;">
      <div class="card-body d-flex align-items-center justify-content-between">
        <h5 class="card-title mb-0">Installazione manuale GDC RP</h5>
        <div>
          <button id="latest-btn" class="btn btn-primary me-2">Scarica ZIP</button>
          <span id="latest-status" class="badge bg-secondary">Latest</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal per selezione asset -->
  <div class="modal fade" id="assetModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Scegli cosa scaricare</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body d-flex flex-column gap-3" id="modal-buttons">
          <!-- Buttons generated dynamically -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const repo = 'jamnaga/wtf-modpack';
    const apiRoot = `https://api.github.com/repos/${repo}`;
    const themeBtn = document.getElementById('theme-toggle');
    const darkAlert = document.getElementById('dark-alert');
    let latestRelease;

    function applyTheme(dark) {
      document.documentElement.classList.toggle('dark-mode', dark);
      themeBtn.textContent = dark ? 'Light Mode' : 'Dark Mode';
      localStorage.setItem('gdcThemeDark', dark);
    }

    function initTheme() {
      const stored = localStorage.getItem('gdcThemeDark');
      const dark = stored === 'true';
      applyTheme(dark);
      themeBtn.addEventListener('click', () => {
        const isDark = document.documentElement.classList.contains('dark-mode');
        applyTheme(!isDark);
        if (!isDark) hideDarkAlert(); // user activated dark
      });
      // show alert if theme is light and not dismissed
      const dismissed = localStorage.getItem('gdcDarkAlertDismissed') === 'true';
      if (!dark && !dismissed) {
        setTimeout(() => darkAlert.classList.add('show'), 1000);
      }
    }

    function hideDarkAlert() {
      darkAlert.classList.remove('show');
      localStorage.setItem('gdcDarkAlertDismissed', 'true');
    }

    darkAlert.querySelector('.close-alert').addEventListener('click', hideDarkAlert);

    async function init() {
      initTheme();
      const releases = await fetch(`${apiRoot}/releases`).then(r => r.json());
      latestRelease = releases[0];
      setupHero(latestRelease);
      showReleaseCards(releases);
      document.getElementById('latest-btn').onclick = () => window.location.href = `https://github.com/${repo}/archive/refs/heads/latest.zip}`;
      document.getElementById('hero-download-btn').onclick = openAssetModal;
      checkLatest(releases);
    }

    function setupHero(rel) {
      document.getElementById('hero-version').textContent = rel.tag_name;
      document.getElementById('hero-date').textContent = new Date(rel.published_at).toLocaleDateString('it-IT',{day:'2-digit',month:'2-digit',year:'numeric'});
    }

    function openAssetModal() {
      const modalBody = document.getElementById('modal-buttons');
      modalBody.innerHTML = '';
      latestRelease.assets.forEach(asset => {
        let label='', cls='btn-secondary';
        const name=asset.name.toLowerCase();
        if(name==='server.zip'){label='Server'; cls='btn-primary';}
        else if(name==='client.zip'){label='Client Legacy'; cls='btn-warning text-dark';}
        else if(name.endsWith('.mrpack')){label='Modrinth'; cls='btn-success';}
        else if(name==='update.exe'){label='Installer'; cls='btn-purple';}
        if(label){
          const btn=document.createElement('a');
          btn.className=`btn ${cls} w-100 mb-2`;
          btn.href=asset.browser_download_url;
          btn.textContent=`Scarica ${label}`;
          btn.addEventListener('click', () => bootstrap.Modal.getInstance(document.getElementById('assetModal')).hide());
          modalBody.appendChild(btn);
        }
      });
      new bootstrap.Modal(document.getElementById('assetModal')).show();
    }

    function showReleaseCards(releases) {
      const row=document.getElementById('releases-row'); row.innerHTML='';
      releases.forEach((rel,i)=>{
        const col=document.createElement('div'); col.className='col-12 col-md-6 col-lg-4';
        const card=document.createElement('div'); card.className='card h-100';
        card.style.animationDelay=`${(i+1)*100}ms`;
        const body=document.createElement('div'); body.className='card-body d-flex flex-column';
        const title=document.createElement('h6'); title.className='card-title'; title.textContent=rel.name||rel.tag_name; body.appendChild(title);
        if(rel.published_at){
          const date=document.createElement('p'); date.className='card-text text-muted mb-3';
          date.textContent=new Date(rel.published_at).toLocaleDateString('it-IT',{day:'2-digit',month:'2-digit',year:'numeric'});
          body.appendChild(date);
        }
        const btnContainer=document.createElement('div'); btnContainer.className='mt-auto d-flex flex-wrap gap-2';
        rel.assets.forEach(asset=>{
          let label='',cls='btn-secondary'; const nm=asset.name.toLowerCase();
          if(nm==='server.zip'){label='Download Server';cls='btn-primary';}
          else if(nm==='client.zip'){label='Download Client Legacy';cls='btn-warning text-dark';}
          else if(nm.endsWith('.mrpack')){label='Download Modrinth';cls='btn-success';}
          else if(nm==='update.exe'){label='Download Installer';cls='btn-purple';}
          if(label){const a=document.createElement('a');a.className=`btn ${cls} btn-sm`;a.href=asset.browser_download_url;a.textContent=label;btnContainer.appendChild(a);}        
        });
        body.appendChild(btnContainer);card.appendChild(body);col.appendChild(card);row.appendChild(col);
      });
    }

    async function checkLatest(releases){
      try{
        const latestRelease=releases[0];
        const cmp=await fetch(`${apiRoot}/compare/${encodeURIComponent(latestRelease.tag_name)}...latest`).then(r=>r.json());
        const b=document.getElementById('latest-status');
        if(cmp.status==='identical'||cmp.status==='behind'){
          b.className='badge bg-success';b.textContent='Up-to-date';
          const fc=document.querySelector('#releases-row .card'); if(fc)fc.classList.add('border','border-success','border-2');
        } else {b.className='badge bg-secondary';b.textContent='Latest';
          const fc=document.querySelector('#releases-row .card.border-success'); if(fc)fc.classList.remove('border','border-success','border-2');
        }
      }catch(e){console.error(e);}    }

    init();
  </script>
</body>
</html>
